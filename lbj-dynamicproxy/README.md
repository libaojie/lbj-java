# lbj-dynamicproxy 动态代理

    增强对象的功能：
    设计模式：一些通用的解决固定问题的方式
    代理模式
    概念：
    （1）. 真实对象：被代理的对象
    （2）. 代理对象：
    （3）. 代理模式：代理对象代理真实对象，达到增强真实对象功能的目的
    实现方式：
    （1）. 静态代理：有一个类文件描述代理模式
    （2）. 动态代理：在内存中形成代理类

    动态代理实际上是JVM在运行期动态创建class字节码并加载的过程。
    动态代理分为两种，一种是JDK反射机制提供的代理，另一种是CGLIB代理。
    在JDK代理，必须提供接口，而CGLIB则不需要提供接口，
    在JDK动态代理中提供一个Proxy类来创建代理类，而在CGLib动态代理中也提供了一个类似的类Enhancer；
    创建代理对象的两个方法：
    //JDK动态代理
    Proxy.newProxyInstance(三个参数);
    //CGLib动态代理
    Enhancer.create(两个参数);

    
## JDK动态代理
    
    jdk动态代理是jre提供给我们的类库，可以直接使用，不依赖第三方。

### 实现
    ①. 代理对象和真实对象实现相同的接口
    ②. 代理对象 = Proxy.newProxyInstance();
    ③. 使用代理对象调用方法。
    ④. 增强方法

### 原理

    整个JDK动态代理的秘密也就这些，简单一句话，动态代理就是要生成一个包装类对象，由于代理的对象是动态的，所以叫动态代理。由于我们
    需要增强，这个增强是需要留给开发人员开发代码的，因此代理类不能直接包含被代理对象，而是一个InvocationHandler，该
    InvocationHandler包含被代理对象，并负责分发请求给被代理对象，分发前后均可以做增强。从原理可以看出，JDK动态代理是“对象”的代理。

## CGLib

    CGLIB代理主要通过对字节码的操作，为对象引入间接级别，以控制对象的访问。我们知道Java中有一个动态代理也是做这个事情的，那我们为什
    么不直接使用Java动态代理，而要使用CGLIB呢？答案是CGLIB相比于JDK动态代理更加强大，JDK动态代理虽然简单易用，但是其有一个致命缺陷
    是，只能对接口进行代理。如果要代理的类为一个普通类、没有接口，那么Java动态代理就没法使用了。

### 原理
    
    生成一个继承B的类型C（代理类），这个代理类持有一个MethodInterceptor，我们setCallback时传入的。 C重写所有B中的方法（方法名
    一致），然后在C中，构建名叫“CGLIB”+“$父类方法名$”的方法（下面叫cglib方法，所有非private的方法都会被构建），方法体里只有一句话
    super.方法名()，可以简单的认为保持了对父类方法的一个引用，方便调用。

### 实现

    Enhancer可能是CGLIB中最常用的一个类，和Java1.3动态代理中引入的Proxy类差不多(如果对Proxy不懂，可以参考这里)。
    和Proxy不同的是，Enhancer既能够代理普通的class，也能够代理接口。Enhancer创建一个被代理对象的子类并且拦截所有的方法调用
    （包括从Object中继承的toString和hashCode方法）。Enhancer不能够拦截final方法，例如Object.getClass()方法，
    这是由于Java final方法语义决定的。基于同样的道理，Enhancer也不能对fianl类进行代理操作。
    这也是Hibernate为什么不能持久化final class的原因。

### 应用
    应用于AOP框架（Spring、dynaop）中，用以提供方法拦截操作。Hibernate作为一个比较受欢迎的ORM框架，同样使用CGLIB来代理单端
    （多对一和一对一）关联（延迟提取集合使用的另一种机制）
    在Mybatis里两种动态代理技术都已经使用了，在Mybatis中通常在延迟加载的时候才会用到CGLIB动态代理。

## 对比
    
    jdk创建对象的速度远大于cglib，这是由于cglib创建对象时需要操作字节码。cglib执行速度略大于jdk，所以比较适合单例模式。
    另外由于CGLIB的大部分类是直接对Java字节码进行操作，这样生成的类会在Java的永久堆中。如果动态代理操作过多，容易造成永久堆满，触发OutOfMemory异常。spring默认使用jdk动态代理，如果类没有接口，则使用cglib。
